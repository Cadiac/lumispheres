function t(){let j,H,q,G,L,U=t=>Math.sin(6.283184*t),T=t=>.003959503758*2**((t-128)/12),J=[U,t=>t%1<.5?1:-1,t=>t%1*2-1,t=>{t=t%1*4;return t<2?t-1:3-t}];this.init=t=>{j=t,H=t.t,q=0,G=t.o*t.v*(H+1)*2,L=new Int32Array(G)},this.i=()=>{let t,e,a,r,o,v,c,i,n,d,l,m,p,s,f=new Int32Array(G),g=j.l[q],u=j.o,y=j.v,x=0,z=0,w=!1,h=[];for(a=0;a<=H;++a)for(c=g.m[a],r=0;r<y;++r){var _=c?g.c[c-1].f[r]:0,b=(_&&(g.p[_-1]=g.c[c-1].f[r+y]||0,_<17)&&(h=[]),J[g.p[16]]),A=g.p[17]/512,M=2**(g.p[18]-9)/u,C=g.p[19],E=g.p[20],D=43.23529*g.p[21]*3.141592/44100,k=1-g.p[22]/255,B=1e-5*g.p[23],R=g.p[24]/32,S=g.p[25]/512,N=6.283184*2**(g.p[26]-9)/u,P=g.p[27]/255,F=g.p[28]*u&-2;for(l=(a*y+r)*u,o=0;o<4;++o)if(v=c?g.c[c-1].n[r+o*y]:0){h[v]||(h[v]=((t,e,a)=>{let r,o,v,c,i,n,d=J[t.p[0]],l=t.p[1],m=t.p[3]/32,p=J[t.p[4]],s=t.p[5],f=t.p[8]/32,g=t.p[9],u=t.p[10]*t.p[10]*4,y=t.p[11]*t.p[11]*4,x=t.p[12]*t.p[12]*4,z=1/x,w=-t.p[13]/16,h=t.p[14],_=a*2**(2-t.p[15]),b=new Int32Array(u+y+x),A=0,M=0;for(r=0,o=0;r<u+y+x;r++,o++)0<=o&&(h=h>>8|(255&h)<<4,o-=_,i=T(e+(15&h)+t.p[2]-128),n=T(e+(15&h)+t.p[6]-128)*(1+8e-4*t.p[7])),v=1,r<u?v=r/u:r>=u+y&&(v=(1-(v=(r-u-y)*z))*3**(w*v)),A+=i*v**m,c=d(A)*l,M+=n*v**f,c+=p(M)*s,g&&(c+=(2*Math.random()-1)*g),b[r]=80*c*v|0;return b})(g,v,u));var I=h[v];for(e=0,t=2*l;e<I.length;e++,t+=2)f[t]+=I[e]}for(e=0;e<u;e++)i=2*(l+e),(d=f[i])||w?(m=D,C&&(m*=b(M*i)*A+.5),m=1.5*Math.sin(m),x+=m*z,p=k*(d-z)-x,z+=m*p,d=3==E?z:1==E?p:x,B&&(d=(d*=B)<1?-1<d?U(.25*d):-1:1,d/=B),d*=R,w=1e-5<d*d,n=Math.sin(N*i)*S+.5,s=d*(1-n),d*=n):s=0,F<=i&&(s+=f[i-F+1]*P,d+=f[i-F]*P),f[i]=0|s,f[1+i]=0|d,L[i]+=0|s,L[1+i]+=0|d}return++q/j.g},this.u=()=>{var t=44+2*G-8,e=t-36,a=new Uint8Array(44+2*G);a.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(let t=0,e=44;t<G;++t){var r=(r=L[t])<-32767?-32767:32767<r?32767:r;a[e++]=255&r,a[e++]=r>>8&255}return a}}SPHERES=13,DAMPENING=.8,song={l:[{p:[0,28,128,0,0,28,128,12,0,0,12,0,72,0,0,0,0,0,0,0,2,255,0,0,32,83,3,130,4],m:[3,3,3,3,1,2,1,2,1,2,1,2,1,2,1,2,1,2],c:[{n:[131,,143,,,,143,,,,,,,143,131,,130,,142,,,,142,,,,,,,142,130,,138,138,,150,,138,,150,,,,,150,,,,137,137,,137,,137,,137,,,,,149,,,,142,,142,,154,,142,,154,,,154,,,,,140,,140,,152,,140,,152,,,152,,,,,145,,,145,,,,145,,157,157,,,,,,147,,,147,,,,147,,159,159],f:[]},{n:[135,,147,,,,147,,,,,,,147,135,,133,,145,,,,145,,137,,137,,,,,,137,137,,149,,137,,149,,,,,149,,,,138,138,,150,,138,,150,140,140,,140,,140,,140,140,,140,,152,,140,,152,,,152,,,,,140,,140,,152,,140,,147,,147,,147,,147,,,,,,,,,,,144,142,,,,,,142,,,,,154,,,133,,,145,,133],f:[]},{n:[131,,,,,,,,,,,,,,,,130,,142,,,,142,,,,,,,142,130],f:[]}]},{p:[0,91,128,0,0,95,128,12,0,0,12,0,72,0,0,0,0,0,0,0,2,255,0,0,32,83,3,130,4],m:[,,,,1,2,1,2,1,2,1,2,1,2,1,2,1,2],c:[{n:[116,,,,,,,,,,,,,,,,118],f:[]},{n:[121,,,,,,,,,,,,,,,,114,,,,,,,,121,,,,,,,,,,,,,,,,,,,,,,,,131],f:[]}]},{p:[0,255,116,79,0,255,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],m:[,1,,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2],c:[{n:[135,,,,,,,,135,,135],f:[]},{n:[,,,,,,,,135,,,,135,,,,135,,135,,135,,,,135,,,,135],f:[]}]},{p:[0,0,140,0,0,0,140,0,0,81,4,10,47,55,0,0,0,187,5,0,1,239,135,0,32,108,5,16,4],m:[,,,,,,1,2,1,2,1,2,1,2,1,2,1,2],c:[{n:[135,135,135,135,135,135,135,135,,,,,,,135,,,,135,,,,,,135,,,,,,135],f:[]},{n:[135,,,,135,,,,135,,,,135,,,,135,,,,135,,,,135,,,,135],f:[]}]},{p:[0,0,128,0,0,0,128,0,0,125,0,1,59,0,0,0,0,0,0,0,1,193,171,0,29,39,3,88,3],m:[,,,,,,1,,1,,1,,1,,1,,1],c:[{n:[135],f:[]}]},{p:[0,127,104,64,0,130,104,0,64,229,4,40,43,51,0,0,0,231,6,1,3,183,15,0,32,128,4,0,0],m:[,,,,,,,,1,,1,,1,,1,,1],c:[{n:[,,,,135],f:[]}]},{p:[3,255,128,0,0,255,140,0,0,127,2,2,47,61,0,0,0,96,3,1,3,94,79,0,95,84,2,12,4],m:[,,,,,,,,1,,1,,1,,1,,1],c:[{n:[,,,,,,135],f:[]}]},{p:[0,0,140,0,0,0,140,0,0,255,158,158,158,0,0,0,0,51,2,1,2,58,239,0,32,88,1,157,2],m:[1,,1],c:[{n:[111],f:[]}]}],o:6615,v:32,t:17,g:8},add=(t,a)=>t.map((t,e)=>t+a[e]),sub=(t,a)=>t.map((t,e)=>t-a[e]),mul=(t,a)=>t.map((t,e)=>t*a[e]),div=(t,e)=>t.map(t=>t/e),sum=t=>t.reduce((t,e)=>t+e);running=!1,run=async()=>{if(!running){running=!0,player=new t,audioCtx=new AudioContext,player.init(song),document.addEventListener("keydown",t=>{"Escape"===t.key&&(state.h=!state.h,audioCtx.close())},!0);const a=document.createElement("canvas");function e(e){for(analyser.getByteFrequencyData(fftDataArray),state.A._=fftDataArray[state.A.offset],e=.5*e+e*state.A._/32,state.C.M.map(t=>{t.D=Math.max(0,t.D-6*e*(1-t.D)),t.k=add(t.k,mul(state.B,[e,e,e])),t.position=add(t.position,mul(t.k,[e,e,e]))}),i=0;i<SPHERES;i++)for(j=i+1;j<SPHERES;j++)t=state.C.M[i],a=state.C.M[j],[dx,dy,dz]=dxyz=sub(a.position,t.position),d=Math.sqrt(dx*dx+dy*dy+dz*dz),0<(o=t.R+a.R-d)&&([nx,ny,nz]=nxyz=div(dxyz,d),v1i=sum(mul(t.k,nxyz)),v2i=sum(mul(a.k,nxyz)),dv1=(v1i*(t.S-a.S)+2*a.S*v2i)/(t.S+a.S)-v1i,dv2=(v2i*(a.S-t.S)+2*t.S*v1i)/(t.S+a.S)-v2i,t.k=add(t.k,mul([dv1,dv1,dv1],nxyz)),a.k=add(a.k,mul([dv2,dv2,dv2],nxyz)),tm=t.S+a.S,m1=o*a.S/tm,m2=o*t.S/tm,t.position=sub(t.position,mul([m1,m1,m1],nxyz)),a.position=add(a.position,mul([m2,m2,m2],nxyz)),t.D=a.D=.999);var t,a;state.C.M.forEach(t=>{for(i=0;i<3;i++){var e=1==i?state.P.y:-state.P.size,a=1==i?2*state.P.size+state.P.y:state.P.size;t.position[i]-t.R<e&&(t.k[i]=-t.k[i]*DAMPENING,t.position[i]=e+t.R,t.D=.99),t.position[i]+t.R>a&&(t.k[i]=-t.k[i]*DAMPENING,t.position[i]=a-t.R,t.D=.99)}})}function r(){state.now=performance.now()-state.F;var t=(state.now-state.I)/1e3;state.I=state.now,state.h||(e(t),window.innerWidth==state.N.x&&window.innerHeight==state.N.y||(state.N.x=window.innerWidth,state.N.y=window.innerHeight,a.width=window.innerWidth,a.height=window.innerHeight),gl.viewport(0,0,state.N.x,state.N.y),gl.clearColor(0,0,0,1),gl.clear(16384),gl.useProgram(program),gl.uniform1f(gl.getUniformLocation(program,"u_time"),state.now),gl.uniform1f(gl.getUniformLocation(program,"u_beat"),state.A._),gl.uniform2f(gl.getUniformLocation(program,"u_resolution"),state.N.x,state.N.y),gl.uniform1f(gl.getUniformLocation(program,"u_fov"),state.H.j),gl.uniform3f(gl.getUniformLocation(program,"u_camera"),state.H.position.x,state.H.position.y,state.H.position.z),gl.uniform3f(gl.getUniformLocation(program,"u_target"),state.H.target.x,state.H.target.y,state.H.target.z),gl.uniform3f(gl.getUniformLocation(program,"u_sun"),state.q.x,state.q.y,state.q.z),gl.uniform3f(gl.getUniformLocation(program,"u_fog_color"),...div(state.G.color,255)),gl.uniform1f(gl.getUniformLocation(program,"u_fog_intensity"),state.G.L),gl.uniform3f(gl.getUniformLocation(program,"u_sky_color"),...div(state.U.color,255)),gl.uniform3f(gl.getUniformLocation(program,"u_color_shift"),...div(state.T.T,255)),gl.uniform4fv(gl.getUniformLocation(program,"u_spheres"),state.C.M.flatMap(t=>[...t.position,t.R+t.D])),gl.uniform1f(gl.getUniformLocation(program,"u_box_y"),state.P.y),gl.uniform1f(gl.getUniformLocation(program,"u_box_size"),state.P.size),gl.uniform3f(gl.getUniformLocation(program,"u_palette_a"),...div(state.palette.a,255)),gl.uniform3f(gl.getUniformLocation(program,"u_palette_b"),...div(state.palette.b,255)),gl.uniform3f(gl.getUniformLocation(program,"u_palette_c"),...div(state.palette.c,255)),gl.uniform3f(gl.getUniformLocation(program,"u_palette_d"),...div(state.palette.d,255)),gl.uniform1f(gl.getUniformLocation(program,"u_palette_offset"),state.palette.offset),gl.uniform1f(gl.getUniformLocation(program,"u_palette_range"),state.palette.range),gl.uniform1f(gl.getUniformLocation(program,"u_palette_period"),state.palette.J),gl.drawArrays(5,0,4),window.requestAnimationFrame(r))}document.body.appendChild(a),a.style.position="fixed",a.style.left=a.style.top=0,gl=a.getContext("webgl"),program=gl.createProgram(),!function t(){var e,a;1<=player.i()?(e=player.u(),(a=document.createElement("audio")).src=URL.createObjectURL(new Blob([e],{type:"audio/wav"})),a.onplay=()=>audioCtx.resume(),analyser=audioCtx.createAnalyser(),audioCtx.createMediaElementSource(a).connect(analyser),analyser.connect(audioCtx.destination),analyser.fftSize=256,fftDataArray=new Uint8Array(analyser.frequencyBinCount),a.play(),shader=gl.createShader(35633),gl.shaderSource(shader,"attribute vec2 p;void main(){gl_Position=vec4(p,0,1);}"),gl.compileShader(shader),gl.attachShader(program,shader),shader=gl.createShader(35632),gl.shaderSource(shader,"precision highp float;uniform float v,z,d;uniform vec2 m;uniform vec3 f,a,c,k;uniform float h;uniform vec3 i,y,l,s,n,w;uniform float r,C,F,e,p;uniform vec4 g[13];struct R{vec2 d;vec3 m;int i;bool h;};vec2 t(vec2 p,vec2 d){return p.y<d.y?p:d;}float t(vec3 v){return dot(v,v);}float t(vec3 p,vec3 v,vec3 m,vec3 f,vec3 z){vec3 d=m-v,y=p-v,c=f-m,x=p-m,n=z-f,w=p-f,i=v-z,a=p-z,r=cross(d,i);return sqrt(sign(dot(cross(d,r),y))+sign(dot(cross(c,r),x))+sign(dot(cross(n,r),w))+sign(dot(cross(i,r),a))<3.?min(min(min(t(d*clamp(dot(d,y)/t(d),0.,1.)-y),t(c*clamp(dot(c,x)/t(c),0.,1.)-x)),t(n*clamp(dot(n,w)/t(n),0.,1.)-w)),t(i*clamp(dot(i,a)/t(i),0.,1.)-a)):dot(r,y)*dot(r,y)/t(r));}vec4 x;vec2 D(vec3 v){float m=e;vec2 d=vec2(1,dot(v,vec3(0,1,0)));d=t(d,vec2(5,t(v,vec3(p,m,-p),vec3(p,2.*p+m,-p),vec3(-p,2.*p+m,-p),vec3(-p,m,-p))));d=t(d,vec2(3,t(v,vec3(p,m,p),vec3(p,m,-p),vec3(p,2.*p+m,-p),vec3(p,2.*p+m,p))));d=t(d,vec2(4,t(v,vec3(-p,m,p),vec3(-p,m,-p),vec3(-p,2.*p+m,-p),vec3(-p,2.*p+m,p))));d=t(d,vec2(2,t(v,vec3(p,2.*p+m,p),vec3(-p,2.*p+m,p),vec3(-p,2.*p+m,-p),vec3(p,2.*p+m,-p))));d=t(d,vec2(1,t(v,vec3(p,m,p),vec3(-p,m,p),vec3(-p,m,-p),vec3(p,m,-p))));for(int f=0;f<13;++f){vec2 c=vec2(7.+float(f),length(v-g[f].xyz)-floor(g[f].w));if(c.y<d.y)d=c,x=g[f];}return d;}vec3 D(vec3 p,vec3 d){vec3 v=exp2(-abs((2.5e4-p.y)/d.y)*1e-5*y);return(i-.5*d.y)*v+(1.-v)*k;}float D(vec3 p,vec3 v,vec4 d){vec3 m=d.xyz-p;float c=length(m),f=dot(v,m),y=f,i=floor(d.w);if(f<i)y=pow(clamp((f+i)/(2.*i),0.,1.),1.5)*i;return clamp(i*i*y/(c*c*c),0.,1.);}float B(vec3 v,vec3 p){float d=1.;for(int f=0;f<13;f++)d*=1.-D(v,p,g[f]);return d;}float B(vec3 p,vec3 v,vec4 d){vec3 m=d.xyz-p;float y=sqrt(dot(m,m));return max(0.,dot(v,m/y)*(floor(d.w)/y)*fract(d.w));}vec3 B(float p){return l+s*cos(6.28318*(n*(r+C*sin(F*p+v/1e3))+w));}vec3 B(vec3 d,vec3 m,vec3 p,float v){vec3 f=B(v-7./float(13));float c=B(d,p);vec3 y=vec3(0);for(int i=0;i<13;i++)y+=B(d,p,g[i])*B(float(i)/float(13));vec3 i=vec3(1)*c*(1.-sqrt((.5+.5*-p.y)/(d.y+.5))*.5)*.4;i+=y+(v>=7.?f*fract(x.w):vec3(0));return i;}R A(vec3 p,vec3 d){float v=1e-4,m=1e-4;R f;for(int i=0;i<500;i++){v=.001*m;f.m=p+m*d;f.d=D(f.m);if(f.d.y<v){f.h=true;f.i=i;break;}m+=f.d.y;if(m>=2e2)break;}f.d.y=m;return f;}float A(vec2 p,vec2 v,vec2 d){vec2 m=max(abs(v),abs(d))+.01,y=p+.5*m,i=p-.5*m,f=(floor(y)+min(fract(y)*60.,1.)-floor(i)-min(fract(i)*60.,1.))/(60.*m);return(1.-f.x)*(1.-f.y);}mat4 E(vec3 p,vec3 v){vec3 m=normalize(v-p),d=normalize(cross(normalize(vec3(0,1,0)),m));return mat4(vec4(d,0),vec4(cross(m,d),0),vec4(-m,0),vec4(0,0,0,1));}vec3 A(vec3 v,vec3 p,vec3 d,vec2 m,float f){mat4 i=E(v,p);vec3 c=(i*vec4(normalize(vec3(m,-f)),0)).xyz,n=(i*vec4(normalize(vec3(m+vec2(1,0),-f)),0)).xyz,r=(i*vec4(normalize(vec3(m+vec2(0,1),-f)),0)).xyz,z=vec3(0);float w=1.,a=0.;for(int u=0;u<5;u++){R g=A(v,c);if(!g.h){z=mix(z,D(v,c),w);float s=clamp(dot(d,c),0.,1.);z+=.5*vec3(1,.5,.2)*pow(s,32.);break;}a+=g.d.y;vec3 s;s=g.d.x>=7.?normalize(g.m-x.xyz):g.d.x==1.?vec3(0,1,0):g.d.x==2.?vec3(0,-1,0):g.d.x==3.?vec3(-1,0,0):g.d.x==4.?vec3(1,0,0):g.d.x==5.?vec3(0,0,1):vec3(0,0,-1);vec3 l=B(g.m,c,s,g.d.x);z=mix(z,l,w);vec3 t=exp2(-a*h*y);if(g.d.x!=1.){z=z*t+(1.-t)*k;break;}w=clamp(1.+dot(c,s),0.,1.);w=.01+.4*pow(w,3.5)+.5;vec3 F=v-n*dot(v-g.m,s)/dot(n,s),C=v-r*dot(v-g.m,s)/dot(r,s);float e=A(.5*g.m.xz,.5*(F.xz-g.m.xz),.5*(C.xz-g.m.xz));w*=.5*e;z*=e;z=z*t+(1.-t)*k;v=g.m;c=reflect(c,s);}return z;}void main(){vec2 p=gl_FragCoord.xy-m/2.;vec3 i=A(f,a,normalize(c),p,m.y/tan(radians(d)/2.));i=pow(i,y);i*=vec3(1.02,.99,.9);i.z=i.z+.1;i=smoothstep(0.,1.,i);if(v<2e3)i=mix(i,vec3(0),(2e3-v)/2e3);gl_FragColor=vec4(i,1);}"),gl.compileShader(shader),gl.attachShader(program,shader),gl.linkProgram(program),gl.bindBuffer(34962,gl.createBuffer()),gl.bufferData(34962,new Float32Array([1,1,1,-1,-1,1,-1,-1]),35044),gl.enableVertexAttribArray(0),gl.vertexAttribPointer(0,2,5126,!1,0,0),state={h:!1,F:performance.now(),now:0,K:0,I:0,N:{x:0,y:0},B:[0,0,0],H:{j:60,position:{x:0,y:20,z:60},target:{x:0,y:20,z:0}},q:{x:-1.23,y:2,z:-100},G:{color:[230,97,205],L:.005},U:{color:[61,245,245]},T:{T:[255,235,255]},palette:{a:[95,28,28],b:[174,74,74],c:[9,9,203],d:[48,40,40],offset:0,range:1,J:10},C:{M:[...Array(SPHERES)].map((t,e)=>{return a=5*Math.random()-5,r=15+5*Math.random(),o=5*Math.random()-5,e=e%3+1,{position:[a,r,o],k:[-.5+Math.random(),-.5+Math.random(),-.5+Math.random()],D:0,R:e,S:4/3*Math.PI*Math.pow(e,3)};var a,r,o})},P:{y:10,size:10},A:{offset:90,_:0}},window.requestAnimationFrame(r)):setTimeout(t,50)}()}};
